---
title: 'Exploring Baby Names'
author: 'Auren Ferguson'
date: '27 December 2016'
output:
  html_document:
    fig_height: 5
    fig_width: 7
    highlight: tango
    number_sections: yes
    theme: readable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
This document explores US baby naming trends from 1910-2015. The data can be downloaded from <http://www.ssa.gov/oact/babynames/state/namesbystate.zip>

# Exploring Baby Names
## Loading librarys


```{r, message=FALSE}
library(data.table)
library(dplyr)
library(ggplot2)
library(scales)
```

## Reading Data In and Aggregating

The data comes in the format of names by year for each state. In order to get a national figure we have to read in the data from each and bind them together.

```{r, message= F}
# filelist = list.files(path = "/Users/aurenferguson/Downloads/namesbystate", pattern = ".TXT")
# 
# datalist = lapply(filelist, function(x)read.csv(x, header=F)) 
# 
# #assuming the same header/columns for all files
# baby_names = bind_rows(datalist)
# 
# # converting to tbl
# baby_names <- as.tbl(baby_names)
# 
# # renaming columns
# baby_names <- dplyr::rename(.data = baby_names, state = V1, sex = V2, year = V3, name = V4, amount = V5)
# 
# fwrite(baby_names, file = "baby_names_all_states.csv")
```

The code is commented out as I have already done this and exported a national csv file which is read in.

```{r}
baby_names <- as.tbl(fread(input = "baby_names_all_states.csv"))
head(baby_names)
```

## Most Popular Baby Names of All Time
Its interesting to see which are the most popular names of all time (1910-2015 anyway)

```{r}
popular_names_all_time <- function(df){
  df <- df %>% group_by(name) %>% summarise(total = sum(amount)) %>%
    arrange(desc(total)) %>% head(10)
  ggplot(data = df, aes(x = reorder(name, -total), y = total, fill = name)) + 
    geom_bar(stat = "identity") +
    scale_y_continuous(labels = comma) +
    guides(fill = FALSE) +
    ylab("Count") +
    xlab("Name") +
    labs(title = "Most poplular names (1910-2015)")
}

popular_names_all_time(baby_names)
 
```

## Gender Ambigious Names
Will try and find the most gender ambiguous names of the whole data set and then on specific years. However, there are many ways to tackle this problem that will get different results. I will use two methods: finding common gender ambiguous names where there are similar amounts of male and females with same name and a method that gets the exact same amount of males and females for a specific year. This method however generally picks out unusual names with low counts.

### Common Ambigious Names

```{r}
Gender_ambig_common_name <- function(df, yr = NULL){
  if(missing(yr)){
    
    # only taking common names i.e, total > 100  
    df <- df %>% group_by(name, sex) %>%
      summarise(total = sum(amount)) %>% arrange(desc(total)) %>% filter(total >= 100)
    
    # Keeps all duplicates, i.e. male and female of same name
    df <- df[duplicated(df$name) | duplicated(df$name, fromLast=TRUE), ]
    
    # Another dataframe that goes to name level,
    #therefore the difference between total is due to amount of male and female
    df_a <- df %>% group_by(name) %>% summarise(total_amt = sum(total)) %>%
      arrange(desc(total_amt)) %>% rename(total_male_female = total_amt)
    
    # Joins the 2 dataframes, allowing a ratio of male female to be calculated
    df <- left_join(df, df_a, by = "name")
    
    # Male/Female calculation ratio of total for each name
    df$ratio <- df$total / df$total_male_female
    
    # selects ratio of 0.5 and removes duplicates for clarity.
    # 0.5 corresponds to a name being exactly half male and half female
    df <- df %>% filter(ratio >= 0.4 & ratio <= 0.6) %>% distinct(name,.keep_all = T) %>%
      arrange(desc(total_male_female)) %>% head(10)
    
    # Visualising results
    ggplot(data = df, aes(x = reorder(name, -total_male_female), y = total_male_female, fill = name)) + 
      geom_bar(stat = "identity") +
      scale_y_continuous(labels = comma) +
      guides(fill = FALSE) +
      ylab("Count") +
      xlab("Name") +
      ggtitle(label = paste("Most common gender ambigious names 1910-2015"))
    
  }else{
    # only taking common names i.e, total > 100  
    df <- df %>% filter(year == yr) %>% group_by(name, sex) %>%
      summarise(total = sum(amount)) %>% arrange(desc(total)) %>% filter(total >= 100)
    
    # Keeps all duplicates, i.e. male and female of same name
    df <- df[duplicated(df$name) | duplicated(df$name, fromLast=TRUE), ]
    
    # Another dataframe that goes to name level,
    #therefore the difference between total is due to amount of male and female
    df_a <- df %>% group_by(name) %>% summarise(total_amt = sum(total)) %>%
      arrange(desc(total_amt)) %>% rename(total_male_female = total_amt)
    
    # Joins the 2 dataframes, allowing a ratio of male female to be calculated
    df <- left_join(df, df_a, by = "name")
    
    # Male/Female calculation ratio of total for each name
    df$ratio <- df$total / df$total_male_female
    
    # selects ratio of 0.5 and removes duplicates for clarity.
    # 0.5 corresponds to a name being exactly half male and half female
    df <- df %>% filter(ratio >= 0.4 & ratio <= 0.6) %>% distinct(name,.keep_all = T) %>%
      arrange(desc(total_male_female)) %>% head(10)
    
    # Visualising results
    ggplot(data = df, aes(x = reorder(name, -total_male_female), y = total_male_female, fill = name)) + 
      geom_bar(stat = "identity") +
      scale_y_continuous(labels = comma) +
      guides(fill = FALSE) +
      ylab("Count") +
      xlab("Name") +
      ggtitle(label = paste("Most common gender ambigious names", yr))
  }
}

# Most ambigious names of all 
Gender_ambig_common_name(df = baby_names)

# Most ambigious names for specific years
Gender_ambig_common_name(df = baby_names, yr = 2013)
Gender_ambig_common_name(df = baby_names, yr = 1945)

```

We can see that Jessie is the most common gender ambiguous name for all years, while in 2013 names such as Skyler and Armani are popular. The names from 1945 are more traditional compared to 2013. 

### Names that have exactly the same amount of male and females by year
This method finds the names that have the exact same amount of males and females. As mentioned earlier, this method tends to pick out unusual names with low counts. However, they are the most ambigious names with:

$$\sum Men = \sum Female$$
```{r}
Gender_ambig_name <- function(df, yr){
  
  # Filters for the year, aggregates to name, sex level and sums amount
  df <- df %>% filter(year == yr) %>% group_by(name, sex) %>%
    summarise(total = sum(amount)) %>% arrange(desc(total))
  
  # Keeps all duplicates, i.e. male and female of same name
  df <- df[duplicated(df$name) | duplicated(df$name, fromLast=TRUE), ]
  
  # Another dataframe that goes to name level,
  #therefore the difference between total is due to amount of male and female
  df_a <- df %>% group_by(name) %>% summarise(total_amt = sum(total)) %>%
    arrange(desc(total_amt)) %>% rename(total_male_female = total_amt)
  
  # Joins the 2 dataframes, allowing a ratio of male female to be calculated
  df <- left_join(df, df_a, by = "name")
  
  # Male/Female calculation ratio of total for each name
  df$ratio <- df$total / df$total_male_female
  
  # selects ratio of 0.5 and removes duplicates for clarity.
  # 0.5 corresponds to a name being exactly half male and half female
  df <- df %>% filter(ratio == 0.5) %>% distinct(name,.keep_all = T)
  
  # Visualising results
  ggplot(data = df, aes(x = reorder(name, -total_male_female), y = total_male_female, fill = name)) + 
    geom_bar(stat = "identity") +
    scale_y_continuous(labels = comma) +
    guides(fill = FALSE) +
    ylab("Count") +
    xlab("Name") +
    ggtitle(label = paste("Most uncommon ambigious names", yr))

}

Gender_ambig_name(baby_names, yr = 2013)
Gender_ambig_name(baby_names, yr = 1946)
Gender_ambig_name(baby_names, yr = 2014) 
```

